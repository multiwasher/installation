<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somengil - Checklist de Instalação Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Sistema de Traduções -->
    <script src="translations.js"></script>
    
    <!-- Estrutura Compliance - Separadores e Campos -->
    <script src="compliance-sections.js"></script>
    
    <!-- Configuração de cores personalizada para Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'somengil-blue': '#004aad', // Azul principal da marca
                        'somengil-light': '#f4f7fa', // Fundo
                        'somengil-dark': '#000000', // Fundo escuro (Preto puro)
                        'somengil-accent': '#2a64b9', // Um tom mais claro para botões hover/secundários
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #d5dcdc; }
        
        /* Ajuste de cores para o fundo PRETO da Sidebar */
        .sidebar-dark-active { 
            background-color: #1f2937; /* Slate-800 escuro para fundo ativo */
            color: #ffffff; /* Texto branco */
            border-right: 3px solid #004aad; /* Linha azul da Somengil */
            font-weight: 600;
        }
        .sidebar-dark-active .section-icon {
            background-color: #004aad; /* Ícone azul ativo */
            color: #ffffff;
        }
        .sidebar-dark-inactive { 
            color: #94a3b8; /* Slate-400 para texto inativo */
            border-right: 3px solid transparent; 
        }
        .sidebar-dark-inactive:hover { 
            background-color: #111827; /* Slate-900 para hover muito escuro */
            color: #ffffff; 
        }
        .sidebar-dark-inactive .section-icon {
             background-color: #1f2937; /* Slate-800 para ícone inativo */
             color: #94a3b8;
        }
        
        /* Estilos globais antigos (mantidos, mas substituídos na sidebar) */
        .tab-active { 
            background-color: #e6f0ff; 
            color: #004aad; 
            border-right: 3px solid #004aad; 
            font-weight: 600;
        }
        .tab-inactive { 
            color: #64748b; 
            border-right: 3px solid transparent; 
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Custom radio styling for better touch target */
        input[type="radio"],
        input[type="radio"].form-radio,
        .form-radio {
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            width: 1.25rem !important;
            height: 1.25rem !important;
            border-radius: 50% !important;
            border: 2px solid #6b7280 !important; /* Gray-500 - mais escuro */
            transition: all 0.2s !important;
            cursor: pointer !important;
            display: inline-block !important;
            position: relative !important;
            flex-shrink: 0 !important;
            background-color: white !important;
            margin: 0 !important;
            vertical-align: middle !important;
        }
        input[type="radio"]:checked,
        input[type="radio"].form-radio:checked,
        .form-radio:checked {
            border-color: #004aad !important;
            background-color: #004aad !important; /* Somengil Blue */
            box-shadow: 0 0 0 4px #e6f0ff !important; /* Ring-2 Light Blue */
        }
        input[type="radio"]:checked::after,
        input[type="radio"].form-radio:checked::after,
        .form-radio:checked::after {
            content: '' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 0.5rem !important;
            height: 0.5rem !important;
            border-radius: 50% !important;
            background-color: white !important;
        }
        input[type="radio"]:focus,
        input[type="radio"].form-radio:focus,
        .form-radio:focus {
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(0, 74, 173, 0.3) !important;
        }
        
        /* Estilos para botões de idioma */
        .language-btn {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
            color: #475569;
            font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', 'Inter', sans-serif;
            font-size: 1.125rem;
        }
        .language-btn:hover {
            background-color: #e2e8f0;
            border-color: #94a3b8;
        }
        .language-btn.active {
            background-color: #004aad;
            border-color: #004aad;
            color: #ffffff;
            font-weight: 700;
        }
        
        /* Mobile Sidebar Overlay */
        .sidebar-overlay {
            display: none;
        }
        @media (max-width: 768px) {
            .sidebar-overlay {
                display: block;
                position: fixed;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s;
            }
            .sidebar-overlay.active {
                opacity: 1;
                pointer-events: auto;
            }
            aside.sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                z-index: 50;
                transition: left 0.3s;
            }
            aside.sidebar.open {
                left: 0;
            }
            #mobile-menu-btn {
                display: flex !important;
            }
        }
        @media (min-width: 769px) {
            aside.sidebar {
                position: relative;
                left: 0 !important;
            }
            #mobile-menu-btn {
                display: none !important;
            }
            .mobile-close-btn {
                display: none !important;
            }
        }
        

        
        /* Garantir scroll nas seções de conteúdo se necessário */
        .content-section {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        @media (max-width: 768px) {
            .content-section {
                max-height: calc(100vh - 200px);
            }
        }
    </style>
</head>
<body class="text-somengil-dark h-screen flex flex-col overflow-hidden">

    <!-- Application Logic (Refatorada para usar apenas Apps Script) -->
    <script type="module">
        // Global State
        const state = {
            serial: null,
            data: {},
            loading: false,
            activeTab: 'section-1'
        };
        
        // Tornar state acessível globalmente
        window.appState = state;

        // URL do Google Apps Script para sincronização (Escrita/Leitura/Email)
        const GOOGLE_SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwoy-S0Ekip6iIheoRxMxOjCPxQc0mv6R5337o0BWr9Bhns0Z3lXK1MYSCi4SKDPsbf/exec"; 

        // NOVO: Valores padrão vazios para garantir que campos não preenchidos no Sheets fiquem em branco na App.
        const emptyDefaults = {
            // I. Técnico
            tecnicoNome: "", tecnicoEmail: "", tecnicoTelefone: "",
            // II. Cliente
            clienteNome: "", clienteNIF: "", clienteMorada: "", clienteEmail: "", 
            clienteCodigoPostal: "", clienteCidade: "", clienteRepresentante: "", clienteTelefone: "", clientePais: "",
            // III. Equipamento
            equipamentoModelo: "", equipamentoVoltagem: "", equipamentoFrequencia: "", equipamentoAquecimento: "",
            // IV. Montagem
            condicaoMontagem: "", instalacaoTipo: "", responsabilidadeGradil: "",
            // V. Checklist (Booleans/Enums)
            podeReceberTIR: "", temEmpilhador: "", podeDescarregarSemTecnico: "", temTecnicoAuxiliar: "",
            podeArmazenar: "", necessarioCintas: "", temAguaSala: "", adaptadorAguaTamanho: "",
            temEnergiaEletrica: "", temEscadas: "", temFichaEletrica: "", amperesOpcao: "",
            temDetergentes: "", documentacaoFabrica: "", equipamentoProtecao: "", chaoAcabado: "",
            drenoPreparado: "", ventilacaoPreparada: "", operadorPresente: "", operadorNome: "",
            responsavelComissionamentoPresente: "", responsavelComissionamentoNome: "", temUtensiliosSujos: "",
            // VI. Info (Números devem ser null)
            ligacoesPressaoAgua: "", marcaProdutosQuimicos: "", medicaoPortaLargura: null, medicaoPortaAltura: null, 
            medicaoChaoTecto: null, horarioTrabalhoInicio: "", horarioTrabalhoFim: "", dataEntregaPrevista: "", observacoes: "",
            // VII. FOTOS E FICHEIROS (NOVO CAMPO)
            linksFotosFicheiros: "",
            fotosEnviadas: "",
            dataEnvioFotos: "",
        };
        
        // Default Data Structure (Usado apenas para iteração e definição de campos)
        const defaultData = emptyDefaults;
        
        // Campos Mínimos para Criação de Novo Equipamento (Secções I, II, III, IV)
        const creationFields = [
            'tecnicoNome', 'tecnicoEmail', 'tecnicoTelefone',
            'clienteNome', 'clienteNIF', 'clienteMorada', 'clienteEmail', 
            'clienteCodigoPostal', 'clienteCidade', 'clienteRepresentante', 'clienteTelefone', 'clientePais',
            'equipamentoModelo', 'equipamentoVoltagem', 'equipamentoFrequencia', 'equipamentoAquecimento',
            'condicaoMontagem', 'instalacaoTipo', 'responsabilidadeGradil'
        ];

        // Mapeamento de chaves para secções para calcular o progresso por separador
        const sectionMap = {
            // I. Técnico (3 campos)
            tecnicoNome: 'section-1', tecnicoEmail: 'section-1', tecnicoTelefone: 'section-1',
            // II. Cliente (9 campos)
            clienteNome: 'section-2', clienteNIF: 'section-2', clienteMorada: 'section-2', clienteEmail: 'section-2', 
            clienteCodigoPostal: 'section-2', clienteCidade: 'section-2', clienteRepresentante: 'section-2', clienteTelefone: 'section-2', clientePais: 'section-2',
            // III. Equipamento (4 campos)
            equipamentoModelo: 'section-3', equipamentoVoltagem: 'section-3', equipamentoFrequencia: 'section-3', equipamentoAquecimento: 'section-3',
            // IV. Montagem (3 campos)
            condicaoMontagem: 'section-4', instalacaoTipo: 'section-4', responsabilidadeGradil: 'section-4',
            // V. Logística & Local (22 campos)
            podeReceberTIR: 'section-5', temEmpilhador: 'section-5', podeDescarregarSemTecnico: 'section-5', temTecnicoAuxiliar: 'section-5',
            podeArmazenar: 'section-5', necessarioCintas: 'section-5', temAguaSala: 'section-5', adaptadorAguaTamanho: 'section-5',
            temEnergiaEletrica: 'section-5', temEscadas: 'section-5', temFichaEletrica: 'section-5', amperesOpcao: 'section-5',
            temDetergentes: 'section-5', documentacaoFabrica: 'section-5', equipamentoProtecao: 'section-5', chaoAcabado: 'section-5',
            drenoPreparado: 'section-5', ventilacaoPreparada: 'section-5', operadorPresente: 'section-5', operadorNome: 'section-5',
            responsavelComissionamentoPresente: 'section-5', responsavelComissionamentoNome: 'section-5', temUtensiliosSujos: 'section-5',
            // VI. Info & Medições (9 campos)
            ligacoesPressaoAgua: 'section-6', marcaProdutosQuimicos: 'section-6', medicaoPortaLargura: 'section-6', medicaoPortaAltura: 'section-6', 
            medicaoChaoTecto: 'section-6', horarioTrabalhoInicio: 'section-6', horarioTrabalhoFim: 'section-6', dataEntregaPrevista: 'section-6', observacoes: 'section-6',
            // VII. Fotos e Ficheiros (1 campo - NOVO: apenas fotosEnviadas conta para progresso)
            fotosEnviadas: 'section-7',
            dataEnvioFotos: 'section-7'
        };


        // --- Login Credentials ---
        const LOGIN_CREDENTIALS = {
            '123': { username: 'Tiago', destination: 'action' },
            '456': { username: 'Diogo', destination: 'action' },
            '789': { username: 'Miguel', destination: 'action' },
            '101': { username: 'Richard', destination: 'action' },
            '102': { username: 'Leonel', destination: 'action' },
            '112': { username: 'GESTÃO', destination: 'creation' },
            '911': { username: 'Voos', destination: 'maps' }
        };

        // Função de Login
        window.handleLogin = async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const errorMsg = document.getElementById('login-error-message');
            const btn = document.getElementById('login-btn');
            const spinner = document.getElementById('login-loading-spinner');
            const btnText = document.getElementById('login-btn-text');

            // Limpar mensagem de erro anterior
            errorMsg.classList.add('hidden');
            errorMsg.textContent = '';

            // Validar credenciais
            let validCredential = null;
            for (const [pass, cred] of Object.entries(LOGIN_CREDENTIALS)) {
                if (password === pass && username.toLowerCase() === cred.username.toLowerCase()) {
                    validCredential = cred;
                    break;
                }
            }

            if (!validCredential) {
                errorMsg.textContent = window.translate('Credenciais inválidas') || 'Credenciais inválidas';
                errorMsg.classList.remove('hidden');
                return;
            }

            // Mostrar loading
            btn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = window.translate('A entrar...') || 'A entrar...';

            // Aguardar um pouco para simular processamento
            await new Promise(resolve => setTimeout(resolve, 500));

            // Navegar para o destino
            document.getElementById('login-view').classList.add('hidden');
            
            if (validCredential.destination === 'action') {
                document.getElementById('action-view').classList.remove('hidden');
            } else if (validCredential.destination === 'creation') {
                document.getElementById('creation-form-view').classList.remove('hidden');
            } else if (validCredential.destination === 'maps') {
                // Placeholder para Mapa de Viagens
                alert('Funcionalidade de Mapa de Viagens em desenvolvimento');
                btn.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = window.translate('Entrar') || 'Entrar';
                return;
            }

            // Restaurar botão
            btn.disabled = false;
            spinner.classList.add('hidden');
            btnText.textContent = window.translate('Entrar') || 'Entrar';
            
            // Limpar campos
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
        };

        // --- Core Logic ---

        function initApp() {
            // Mostrar tela de login inicialmente
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('action-view').classList.add('hidden');
            document.getElementById('creation-form-view').classList.add('hidden');
            document.getElementById('app-view').classList.add('hidden');
            
            // Define o tab inicial com as classes escuras
            switchTab('section-1', true); 
            console.log("Aplicação iniciada. Fonte de dados: Google Apps Script.");
        }
        
        // NOVO: Navegação para a vista de Criação
        window.showCreationView = () => {
            document.getElementById('action-view').classList.add('hidden');
            document.getElementById('creation-form-view').classList.remove('hidden');
            // Limpar todos os campos do formulário de criação
            clearCreationForm();
            // Mostrar o primeiro tab por padrão
            showCreationTab('new-equipment');
        };
        
        // NOVO: Função para limpar o formulário de criação
        window.clearCreationForm = () => {
            // Limpar campo de serial
            document.getElementById('creationSerialInput').value = '';
            
            // Gerar nova sugestão de serial
            generateSerialSuggestion();
        };
        
        // NOVO: Função para gerar sugestão aleatória (3 números + 1 letra)
        window.generateSerialSuggestion = () => {
            const numbers = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const letter = letters.charAt(Math.floor(Math.random() * letters.length));
            const suggestion = numbers + letter;
            document.getElementById('serialSuggestion').textContent = suggestion;
        };
        
        // NOVO: Função para aplicar a sugestão ao campo
        window.applySuggestion = () => {
            const suggestion = document.getElementById('serialSuggestion').textContent;
            const currentValue = document.getElementById('creationSerialInput').value;
            
            // Se o campo estiver vazio, preencher com a sugestão
            if (!currentValue.trim()) {
                document.getElementById('creationSerialInput').value = suggestion;
            } else {
                // Caso contrário, adicionar a sugestão no final
                document.getElementById('creationSerialInput').value += suggestion;
            }
            
            // Gerar nova sugestão
            generateSerialSuggestion();
        };
        
        // NOVO: Função para alternar entre tabs na création-form-view
        window.showCreationTab = (tabName) => {
            // Esconder todos os tabs
            document.getElementById('tab-content-new-equipment').classList.add('hidden');
            document.getElementById('tab-content-all-equipment').classList.add('hidden');
            
            // Remover classe ativa de todos os botões
            document.getElementById('tab-new-equipment').classList.remove('border-b-2', 'border-somengil-blue', 'text-somengil-blue');
            document.getElementById('tab-new-equipment').classList.add('border-b-2', 'border-transparent', 'text-gray-600');
            
            document.getElementById('tab-all-equipment').classList.remove('border-b-2', 'border-somengil-blue', 'text-somengil-blue');
            document.getElementById('tab-all-equipment').classList.add('border-b-2', 'border-transparent', 'text-gray-600');
            
            if (tabName === 'new-equipment') {
                document.getElementById('tab-content-new-equipment').classList.remove('hidden');
                document.getElementById('tab-new-equipment').classList.remove('border-b-2', 'border-transparent', 'text-gray-600');
                document.getElementById('tab-new-equipment').classList.add('border-b-2', 'border-somengil-blue', 'text-somengil-blue');
            } else if (tabName === 'all-equipment') {
                document.getElementById('tab-content-all-equipment').classList.remove('hidden');
                document.getElementById('tab-all-equipment').classList.remove('border-b-2', 'border-transparent', 'text-gray-600');
                document.getElementById('tab-all-equipment').classList.add('border-b-2', 'border-somengil-blue', 'text-somengil-blue');
                
                // Carregar dados quando o tab é selecionado
                loadAllEquipments();
            }
        };
        
        // NOVO: Função para carregar todos os equipamentos
        window.loadAllEquipments = async () => {
            const loadingDiv = document.getElementById('equipment-loading');
            const containerDiv = document.getElementById('equipment-list-container');
            const emptyDiv = document.getElementById('equipment-empty');
            const tableBody = document.getElementById('equipment-table-body');
            
            try {
                const response = await fetch(GOOGLE_SHEET_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'fetchAll' })
                });
                
                const result = await response.json();
                
                if (result.result === 'success' && result.data && result.data.length > 0) {
                    // Preencher a tabela
                    tableBody.innerHTML = result.data.map((equipment, index) => `
                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                            <td class="border border-gray-300 p-2 font-mono text-sm">${equipment.serial || '-'}</td>
                            <td class="border border-gray-300 p-2 text-sm">${equipment.timestamp || '-'}</td>
                            <td class="border border-gray-300 p-2 text-sm">${equipment.somengil_technician || '-'}</td>
                            <td class="border border-gray-300 p-2 text-sm">${equipment.customer || '-'}</td>
                            <td class="border border-gray-300 p-2 text-sm">${equipment.model_product || '-'}</td>
                            <td class="border border-gray-300 p-2 text-center">
                                <button type="button" onclick="viewEquipmentDetails('${equipment.serial}')" class="text-somengil-blue hover:text-somengil-accent text-sm font-semibold">Ver</button>
                            </td>
                        </tr>
                    `).join('');
                    
                    loadingDiv.classList.add('hidden');
                    containerDiv.classList.remove('hidden');
                    emptyDiv.classList.add('hidden');
                } else {
                    loadingDiv.classList.add('hidden');
                    emptyDiv.classList.remove('hidden');
                    containerDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error('Erro ao carregar equipamentos:', error);
                loadingDiv.classList.add('hidden');
                emptyDiv.classList.remove('hidden');
                containerDiv.classList.add('hidden');
            }
        };
        
        // NOVO: Função para ver detalhes de um equipamento
        window.viewEquipmentDetails = (serial) => {
            state.serial = serial;
            document.getElementById('creation-form-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('display-serial').innerText = `Sheet #${state.serial}`;
            
            // Carregar dados do equipamento
            loadSheetData(state.serial);
            switchTab('section-1', true);
        };

        // NOVO: Navegação para a vista de Ações
        window.showActionView = () => {
            document.getElementById('app-view').classList.add('hidden');
            document.getElementById('creation-form-view').classList.add('hidden');
            document.getElementById('accessSerialInput').value = '';
            document.getElementById('creationSerialInput').value = '';
            document.getElementById('action-view').classList.remove('hidden');
        };
        
        // NOVO: Tenta criar um novo separador/equipamento
        window.createNewEquipment = async (e) => {
            e.preventDefault();
            const serial = document.getElementById('creationSerialInput').value.trim();
            if (!serial) return;
            
            showLoading(true);
            
            // 1. Apenas usar o número de série - os campos de criação foram removidos
            let creationData = {};
            
            // 2. Preenche o estado global usando emptyDefaults para que tudo fique vazio
            state.serial = serial;
            state.data = { ...emptyDefaults, ...creationData }; // USA emptyDefaults
            
            // 3. Salvar (O Apps Script criará o separador se necessário)
            await saveData(true); // Força a gravação após a criação
            
            // 4. Transiciona para a aplicação principal
            document.getElementById('creation-form-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('display-serial').innerText = `S/n: ${state.serial}`;
            
            // Recarrega o formulário principal com os dados
            populateForm(state.data);
            window.calculateAndDisplayProgress(state.data);
            switchTab('section-1', true); // Garante que a primeira aba é mostrada e tem a classe escura ativa
            showLoading(false);
        };


        // Função de login (agora renomeada para Aceder a um Equipamento Existente)
        window.accessExistingEquipment = async (e) => {
            e.preventDefault();
            const serialInput = document.getElementById('accessSerialInput').value.trim();
            const errorMsg = document.getElementById('access-error-message');
            const btn = document.getElementById('access-btn');
            const spinner = document.getElementById('access-loading-spinner');
            const btnText = document.getElementById('access-btn-text');
            
            if (!serialInput) return;

            // Mostrar loading
            btn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = window.translate('A carregar...') || 'A carregar...';

            // Limpar mensagem de erro anterior
            errorMsg.classList.add('hidden');
            errorMsg.textContent = '';

            try {
                // Tenta abrir o formulário e carregar dados
                state.serial = serialInput;
                document.getElementById('action-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('display-serial').innerText = `S/n: ${state.serial}`;
                
                await window.loadSheetData(state.serial);
            } catch (error) {
                console.error("Erro ao aceder ao equipamento:", error);
                errorMsg.textContent = window.translate('Equipamento não encontrado. Crie um novo equipamento ou verifique o número de série.');
                errorMsg.setAttribute('data-translate-key', 'Equipamento não encontrado. Crie um novo equipamento ou verifique o número de série.');
                errorMsg.classList.remove('hidden');
                
                // Voltar à tela anterior
                document.getElementById('app-view').classList.add('hidden');
                document.getElementById('action-view').classList.remove('hidden');
            } finally {
                // Restaurar botão
                btn.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = window.translate('Aceder e Editar') || 'Aceder e Editar';
            }
        };

        // NOVO: Adaptação da função saveData para ser usada na criação e gravação normal
        window.saveData = async (isInitialCreation = false, propagateError = false) => {
            if (!state.serial) return;

            // Usar os defaults de Compliance se disponíveis
            const defaults = window.complianceEmptyDefaults || emptyDefaults;

            let newData = {};
            let isSheetSyncSuccessful = true;

            try {
                // 1. Coletar dados:
                if (isInitialCreation) {
                    // FIX: Se é criação inicial, a fonte de dados é o state.data (preenchido no createNewEquipment).
                    for (const key in defaults) {
                        // Usa o valor em state.data (com os dados de criação), senão usa o valor vazio.
                        newData[key] = state.data[key] !== undefined ? state.data[key] : defaults[key];
                    }
                } else {
                    // Caso contrário (salvamento normal), lemos o formulário principal visível.
                    for (const key in defaults) {
                        const input = document.getElementById(`field-${key}`);
                        if (input) {
                             if (input.type === 'number') {
                                 newData[key] = input.value === "" ? null : Number(input.value);
                             } else if (input.type === 'checkbox') {
                                 newData[key] = input.checked ? 'true' : '';
                             } else {
                                newData[key] = input.value;
                             }
                        } else {
                            // Trata campos de rádio/checkbox E hidden inputs dos botões toggle
                            const checkedRadio = document.querySelector(`input[name="${key}"]:checked`);
                            const hiddenInput = document.querySelector(`input[type="hidden"][name="${key}"]`);
                            
                            if (checkedRadio) {
                                newData[key] = checkedRadio.value;
                            } else if (hiddenInput) {
                                // Para botões toggle que usam hidden inputs
                                newData[key] = hiddenInput.value || defaults[key] || "";
                            } else {
                                 // Se não for rádio checked nem hidden input, assume o valor vazio/nulo do emptyDefaults
                                 newData[key] = defaults[key] || "";
                            }
                        }
                    }
                    // Atualiza o state.data com os dados lidos do formulário
                    state.data = {...state.data, ...newData};
                }


                // 2. Sincronizar com o Google Sheets API (escrita) - Usa o 'newData' preenchido acima
                if (GOOGLE_SHEET_API_URL && GOOGLE_SHEET_API_URL.startsWith('http')) {
                    try {
                        const sheetPayload = {
                            serial: state.serial,
                            data: newData, // CORRETO: Usa o newData
                            timestamp: new Date().toISOString(),
                            action: 'write',
                            isInitialCreation: isInitialCreation // Flag para indicar se é nova criação
                        };
                        
                        const response = await fetch(GOOGLE_SHEET_API_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(sheetPayload)
                        });
                        console.log("Data sent to Google Sheets API.");

                    } catch (sheetError) {
                        isSheetSyncSuccessful = false;
                        console.warn("Could not synchronize with Google Sheets API:", sheetError);
                    }
                }


                // 3. Atualizar progresso
                window.calculateAndDisplayProgress(state.data); 

            } catch (error) {
                console.error("Save error:", error);
                if (propagateError) {
                    throw error; // Apenas propaga quando explicitamente solicitado
                }
            }
        };

        // Nova função para botões de guardar nas secções com feedback visual
        window.saveDataWithFeedback = async function(buttonElement) {
            const originalHTML = buttonElement.innerHTML;
            
            // Mostrar loading
            buttonElement.disabled = true;
            buttonElement.innerHTML = `
                <svg class="animate-spin h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-2">${window.translate('A guardar...') || 'A guardar...'}</span>
            `;
            
            try {
                // Chama a função saveData existente
                await window.saveData(false, true);
                
                // Mostrar sucesso
                buttonElement.classList.remove('bg-somengil-blue');
                buttonElement.classList.add('bg-emerald-600');
                buttonElement.innerHTML = `
                    <span class="text-lg">✓</span>
                    <span class="ml-2">${window.translate('Guardado!') || 'Guardado!'}</span>
                `;
                
                // Restaurar após 2 segundos
                setTimeout(() => {
                    buttonElement.classList.remove('bg-emerald-600');
                    buttonElement.classList.add('bg-somengil-blue');
                    buttonElement.innerHTML = originalHTML;
                    buttonElement.disabled = false;
                }, 2000);
            } catch (error) {
                // Mostrar erro
                buttonElement.classList.remove('bg-somengil-blue');
                buttonElement.classList.add('bg-red-600');
                buttonElement.innerHTML = `
                    <span class="text-lg">✗</span>
                    <span class="ml-2">${window.translate('Erro!') || 'Erro!'}</span>
                `;
                
                // Restaurar após 2 segundos
                setTimeout(() => {
                    buttonElement.classList.remove('bg-red-600');
                    buttonElement.classList.add('bg-somengil-blue');
                    buttonElement.innerHTML = originalHTML;
                    buttonElement.disabled = false;
                }, 2000);
            }
        };
        // NOVO: Carrega dados do Apps Script (Leitura)
        window.loadSheetData = async function(serial) {
            showLoading(true);
            try {
                // Usar os defaults de Compliance se disponíveis
                const defaults = window.complianceEmptyDefaults || emptyDefaults;
                state.data = { ...defaults };

                // Tenta carregar dados do Apps Script
                if (GOOGLE_SHEET_API_URL && GOOGLE_SHEET_API_URL.startsWith('http')) {
                    try {
                        const payload = { serialNumber: serial, action: 'fetch' };
                        const requestBody = new URLSearchParams(payload).toString();

                        const response = await fetch(GOOGLE_SHEET_API_URL, {
                            method: 'POST',
                            mode: 'cors',
                            headers: { 
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'Accept': 'application/json'
                            },
                            body: requestBody
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.result === 'success' && result.data) {
                                state.data = { ...defaults, ...result.data };
                                // Se temos serial/ID da resposta, armazenar em state.id
                                if (result.data.serial) {
                                    state.id = result.data.serial;
                                    // Extrair apenas a parte aleatória (após o "&")
                                    const randomPart = state.id.includes('&') ? state.id.split('&')[1] : state.id;
                                    document.getElementById('display-serial').innerText = `S/N: ${randomPart}`;
                                }
                            }
                        } else {
                            console.warn("Não foi possível carregar dados do Apps Script (status: " + response.status + ")");
                        }
                    } catch (apiError) {
                        console.warn("Erro ao sincronizar com Google Apps Script:", apiError);
                        // Continua com dados vazios (defaults)
                    }
                }

                // Preencher o formulário
                populateForm(state.data);
                window.calculateAndDisplayProgress(state.data);
                switchTab('installation-responsibility', true);
                showLoading(false);
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                showLoading(false);
            }
        };
        
        // Função que preenche o formulário com os dados carregados
        function populateForm(data) {
            for (const key in data) {
                const val = data[key];
                const input = document.getElementById(`field-${key}`);
                
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = val === 'true' || val === true;
                    } else if (input.type === 'number') {
                        input.value = val !== null && val !== undefined ? val : "";
                    } else {
                        input.value = val || "";
                    }
                }
                
                const radios = document.querySelectorAll(`input[name="${key}"]`);
                if (radios.length > 0) {
                    radios.forEach(r => {
                        if (String(r.value) === String(val)) {
                            r.checked = true;
                        } else {
                            r.checked = false;
                        }
                    });
                }
            }
        }

        /**
         * Exibe o log de envios de fotos na UI
         * @param {string} dataEnvioFotos String com timestamps separados por \n
         */
        window.displayPhotoLog = function(dataEnvioFotos) {
            const logContainer = document.getElementById('log-envios-container');
            const logContent = document.getElementById('log-envios-content');
            
            if (!dataEnvioFotos || dataEnvioFotos.trim() === '') {
                logContainer.classList.add('hidden');
                return;
            }
            
            const timestamps = dataEnvioFotos.split('\n').filter(t => t.trim());
            logContent.innerHTML = timestamps.map((ts, idx) => 
                `<div class="flex items-center">
                    <span class="text-emerald-600 mr-2">●</span>
                    <span>Envio ${idx + 1}: ${ts}</span>
                </div>`
            ).join('');
            logContainer.classList.remove('hidden');
        }

        // --- Visualization Logic (Progress) ---
        let progressChart = null;
        let progressChartMobile = null;

        /**
         * Calcula o progresso global e por secção e atualiza o gráfico e a navegação.
         * @param {object} data Dados do formulário
         */
        window.calculateAndDisplayProgress = function(data) {
            // Usar o mapa de Compliance se disponível, caso contrário usar o antigo
            const fieldDefaults = window.complianceEmptyDefaults || emptyDefaults;
            const sectionMapping = window.complianceSectionMap || sectionMap;
            
            let totalGlobal = 0;
            let filledGlobal = 0;
            const sectionProgress = {};
            
            // Inicializar progress para todas as seções Compliance
            if (window.COMPLIANCE_SECTIONS) {
                COMPLIANCE_SECTIONS.forEach(section => {
                    sectionProgress[section.id] = { total: 0, filled: 0 };
                });
            }

            for (const key in fieldDefaults) {
                const sectionId = sectionMapping[key];
                if (!sectionId) continue;

                totalGlobal++;
                if (!sectionProgress[sectionId]) {
                    sectionProgress[sectionId] = { total: 0, filled: 0 };
                }
                sectionProgress[sectionId].total++;
                
                const val = data[key];
                
                // Considera o campo preenchido se não for nulo, indefinido e a string não for vazia
                if (val !== null && val !== undefined && String(val).trim() !== "") {
                    filledGlobal++;
                    sectionProgress[sectionId].filled++;
                }
            }

            // 1. Atualizar progresso global (Gráficos - Desktop e Mobile)
            const pctGlobal = totalGlobal > 0 ? Math.round((filledGlobal / totalGlobal) * 100) : 0;
            document.getElementById('progress-text').innerText = `${pctGlobal}%`;
            
            const progressTextMobile = document.getElementById('progress-text-mobile');
            if (progressTextMobile) {
                progressTextMobile.innerText = `${pctGlobal}%`;
            }
            
            // Gráfico Desktop
            if (!progressChart) {
                const ctx = document.getElementById('progressChart').getContext('2d');
                progressChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Preenchido', 'Vazio'],
                        datasets: [{
                            data: [filledGlobal, totalGlobal - filledGlobal],
                            backgroundColor: ['#4ade80', '#475569'], // Verde/Slate escuro
                            borderWidth: 0,
                            cutout: '75%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { enabled: false } },
                        animation: { duration: 500 }
                    }
                });
            } else {
                progressChart.data.datasets[0].data = [filledGlobal, totalGlobal - filledGlobal];
                progressChart.data.datasets[0].backgroundColor = ['#4ade80', '#475569'];
                progressChart.update();
            }
            
            // Gráfico Mobile
            const canvasMobile = document.getElementById('progressChartMobile');
            if (canvasMobile) {
                if (!progressChartMobile) {
                    const ctxMobile = canvasMobile.getContext('2d');
                    progressChartMobile = new Chart(ctxMobile, {
                        type: 'doughnut',
                        data: {
                            labels: ['Preenchido', 'Vazio'],
                            datasets: [{
                                data: [filledGlobal, totalGlobal - filledGlobal],
                                backgroundColor: ['#4ade80', '#475569'],
                                borderWidth: 0,
                                cutout: '75%'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { enabled: false } },
                            animation: { duration: 500 }
                        }
                    });
                } else {
                    progressChartMobile.data.datasets[0].data = [filledGlobal, totalGlobal - filledGlobal];
                    progressChartMobile.data.datasets[0].backgroundColor = ['#4ade80', '#475569'];
                    progressChartMobile.update();
                }
            }

            // 2. Atualizar progresso por Secção (Navegação)
            for (const sectionId in sectionProgress) {
                const { total, filled } = sectionProgress[sectionId];
                const pctSection = total > 0 ? Math.round((filled / total) * 100) : 0;
                
                const spanElement = document.getElementById(`pct-${sectionId}`);
                if (spanElement) {
                    spanElement.innerText = `${pctSection}%`;
                    spanElement.classList.remove('text-somengil-blue', 'text-yellow-600', 'text-emerald-600', 'text-gray-400');
                    
                    if (pctSection === 100) {
                        spanElement.classList.add('text-emerald-400'); // Verde mais claro para fundo escuro
                    } else if (pctSection > 0) {
                        spanElement.classList.add('text-yellow-400'); // Amarelo mais claro para fundo escuro
                    } else {
                        spanElement.classList.add('text-slate-500'); // Cinza mais claro para fundo escuro
                    }
                }
            }
        }


        // --- Mobile Sidebar Functions ---
        window.toggleMobileSidebar = function() {
            const sidebar = document.querySelector('aside.sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        };
        
        window.closeMobileSidebar = function() {
            const sidebar = document.querySelector('aside.sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        };
        
        // Fechar sidebar ao clicar em uma seção (mobile)
        document.addEventListener('DOMContentLoaded', function() {
            const navButtons = document.querySelectorAll('.nav-item');
            navButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        closeMobileSidebar();
                    }
                });
            });
        });

        // --- UI Logic ---

        window.switchTab = (tabId, initial = false) => {
            // Verifica se o elemento existe antes de tentar acessá-lo
            const contentSection = document.getElementById(tabId);
            const navButton = document.getElementById(`btn-${tabId}`);
            
            if (!contentSection || !navButton) {
                console.warn(`Elementos não encontrados para tabId: ${tabId}`);
                return;
            }
            
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            contentSection.classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('sidebar-dark-active', 'tab-active');
                el.classList.add('sidebar-dark-inactive');
            });
            
            // Ativa a nova classe de fundo escuro
            navButton.classList.add('sidebar-dark-active');
            navButton.classList.remove('sidebar-dark-inactive');

            // Garante que o ícone do gráfico na sidebar é recalculado para ter as cores corretas do fundo escuro
            if (!initial) {
                 window.calculateAndDisplayProgress(state.data);
            }
            state.activeTab = tabId;
        };

        function showLoading(isLoading) {
            const loader = document.getElementById('loader');
            if (isLoading) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        window.logout = () => {
            state.serial = null;
            state.data = {};
            document.getElementById('app-view').classList.add('hidden');
            document.getElementById('creation-form-view').classList.add('hidden');
            document.getElementById('action-view').classList.add('hidden');
            document.getElementById('accessSerialInput').value = '';
            document.getElementById('creationSerialInput').value = '';
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-view').classList.remove('hidden');
        };

        // Funções de navegação entre secções
        window.goToNextSection = () => {
            const currentIndex = COMPLIANCE_SECTIONS.findIndex(s => s.id === state.activeTab);
            if (currentIndex >= 0 && currentIndex < COMPLIANCE_SECTIONS.length - 1) {
                switchTab(COMPLIANCE_SECTIONS[currentIndex + 1].id);
            }
        };

        window.goToPreviousSection = () => {
            const currentIndex = COMPLIANCE_SECTIONS.findIndex(s => s.id === state.activeTab);
            if (currentIndex > 0) {
                switchTab(COMPLIANCE_SECTIONS[currentIndex - 1].id);
            }
        };

        initComplianceSections();
        setTimeout(() => window.switchTab('installation-responsibility', true), 100);
        
        // Inicializar traduções quando o DOM estiver pronto
        if (typeof initLanguage === 'function') {
            setTimeout(() => {
                initLanguage();
                updateLanguageButtons();
            }, 100);
        }
    </script>

    <!-- LOGIN VIEW (Ecrã Inicial) -->
    <div id="login-view" class="fixed inset-0 overflow-y-scroll bg-somengil-light">
        <div class="min-h-screen flex items-center justify-center p-4 md:p-8">
            <div class="p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-lg text-center my-8" style="background: radial-gradient(circle at center, rgba(81, 184, 234, 1) 0%, rgba(0, 0, 0, 1) 100%);">
                <div class="mb-8">
                    <img src="https://static.wixstatic.com/media/a6967f_0c98d57376be4290aba002d8ba028a92~mv2.webp" 
                         alt="MULTI WASHER" 
                         class="mx-auto h-16 md:h-20 w-auto mb-3"
                         onerror="this.onerror=null; this.innerHTML='<h1 class=\'text-3xl font-bold text-white\'>MULTI WASHER</h1>'">
                    <div class="inline-block p-0.5 rounded-lg mt-1" style="background: linear-gradient(90deg, rgba(81, 184, 234, 1) 0%, rgba(27, 71, 148, 1) 100%);">
                        <div class="px-3 py-1.5 rounded-md bg-black">
                            <p class="text-white font-semibold uppercase text-xs tracking-widest" data-translate="Checklist Instalação">Checklist Instalação</p>
                        </div>
                    </div>
                </div>

                <!-- Seletor de Idioma -->
                <div class="mb-6 pb-6 border-b border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-2" data-translate="Selecione o idioma">Selecione o idioma</label>
                    <div class="flex justify-center gap-1.5 md:gap-2">
                        <!-- PT -->
                        <div class="p-0.5 rounded-lg" style="background: linear-gradient(90deg, rgba(81, 184, 234, 1) 0%, rgba(27, 71, 148, 1) 100%);">
                            <button onclick="setLanguage('pt')" 
                                class="language-btn bg-black px-2 md:px-4 py-2 rounded-md font-semibold transition duration-200 flex items-center gap-1.5 md:gap-2 text-sm md:text-base text-white"
                                data-lang="pt">
                                <svg width="20" height="20" viewBox="0 0 24 24" class="md:w-6 md:h-6" style="border-radius: 2px; overflow: hidden;">
                                    <rect width="10" height="24" fill="#006600"/>
                                    <rect x="10" width="14" height="24" fill="#FF0000"/>
                                </svg>
                                PT
                            </button>
                        </div>
                        <!-- EN -->
                        <div class="p-0.5 rounded-lg" style="background: linear-gradient(90deg, rgba(81, 184, 234, 1) 0%, rgba(27, 71, 148, 1) 100%);">
                            <button onclick="setLanguage('en')" 
                                class="language-btn bg-black px-2 md:px-4 py-2 rounded-md font-semibold transition duration-200 flex items-center gap-1.5 md:gap-2 text-sm md:text-base text-white"
                                data-lang="en">
                                <svg width="20" height="20" viewBox="0 0 24 24" class="md:w-6 md:h-6" style="border-radius: 2px; overflow: hidden;">
                                    <rect width="24" height="24" fill="#012169"/>
                                    <path d="M0,0 L24,24 M24,0 L0,24" stroke="white" stroke-width="3"/>
                                    <path d="M0,0 L24,24 M24,0 L0,24" stroke="#C8102E" stroke-width="2"/>
                                    <path d="M12,0 L12,24 M0,12 L24,12" stroke="white" stroke-width="5"/>
                                    <path d="M12,0 L12,24 M0,12 L24,12" stroke="#C8102E" stroke-width="3"/>
                                </svg>
                                EN
                            </button>
                        </div>
                        <!-- ES -->
                        <div class="p-0.5 rounded-lg" style="background: linear-gradient(90deg, rgba(81, 184, 234, 1) 0%, rgba(27, 71, 148, 1) 100%);">
                            <button onclick="setLanguage('es')" 
                                class="language-btn bg-black px-2 md:px-4 py-2 rounded-md font-semibold transition duration-200 flex items-center gap-1.5 md:gap-2 text-sm md:text-base text-white"
                                data-lang="es">
                                <svg width="20" height="20" viewBox="0 0 24 24" class="md:w-6 md:h-6" style="border-radius: 2px; overflow: hidden;">
                                    <rect width="24" height="6" fill="#AA151B"/>
                                    <rect y="6" width="24" height="12" fill="#F1BF00"/>
                                    <rect y="18" width="24" height="6" fill="#AA151B"/>
                                </svg>
                                ES
                            </button>
                        </div>
                        <!-- FR -->
                        <div class="p-0.5 rounded-lg" style="background: linear-gradient(90deg, rgba(81, 184, 234, 1) 0%, rgba(27, 71, 148, 1) 100%);">
                            <button onclick="setLanguage('fr')" 
                                class="language-btn bg-black px-2 md:px-4 py-2 rounded-md font-semibold transition duration-200 flex items-center gap-1.5 md:gap-2 text-sm md:text-base text-white"
                                data-lang="fr">
                                <svg width="20" height="20" viewBox="0 0 24 24" class="md:w-6 md:h-6" style="border-radius: 2px; overflow: hidden;">
                                    <rect width="8" height="24" fill="#002395"/>
                                    <rect x="8" width="8" height="24" fill="#FFFFFF"/>
                                    <rect x="16" width="8" height="24" fill="#ED2939"/>
                                </svg>
                                FR
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Formulário de Login -->
                <div class="space-y-4">
                    <h2 class="text-2xl font-bold text-white mb-6" data-translate="Bom-vindo">Bom-vindo</h2>
                    <form onsubmit="handleLogin(event)" class="space-y-4">
                        <div>
                            <label class="block text-left text-sm font-medium text-gray-300 mb-2" data-translate="Nome do Utilizador">Nome do Utilizador</label>
                            <input type="text" id="login-username" placeholder="ex: Tiago, Diogo, GESTÃO..." 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-somengil-blue focus:border-somengil-blue outline-none transition text-center text-lg placeholder-slate-400"
                                required>
                        </div>
                        <div>
                            <label class="block text-left text-sm font-medium text-gray-300 mb-2" data-translate="Senha">Senha</label>
                            <input type="password" id="login-password" placeholder="••••••" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-somengil-blue focus:border-somengil-blue outline-none transition text-center text-lg placeholder-slate-400"
                                required>
                        </div>
                        <div id="login-error-message" class="hidden mt-2 p-3 bg-red-900/50 border border-red-600 text-red-300 text-sm rounded-lg text-center"></div>
                        <button type="submit" id="login-btn"
                            class="w-full bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg shadow-somengil-blue/30 flex items-center justify-center gap-2 min-h-[48px]">
                            <svg id="login-loading-spinner" class="hidden animate-spin h-5 w-5 text-white flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="login-btn-text" data-translate="Entrar">Entrar</span>
                        </button>
                    </form>
                </div>
                
                <div class="mt-8 pt-6 border-t border-gray-700 text-xs text-gray-500">
                    &copy; Somengil 2025.
                </div>
            </div>
        </div>
    </div>

    <!-- Action Selection View (Após login) -->
    <div id="action-view" class="hidden fixed inset-0 overflow-y-scroll bg-somengil-light">
        <div class="min-h-screen flex items-center justify-center p-4 md:p-8">
            <div class="p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-lg text-center my-8" style="background: radial-gradient(circle at center, rgba(81, 184, 234, 1) 0%, rgba(0, 0, 0, 1) 100%);">
            <div class="mb-8">
                <img src="https://static.wixstatic.com/media/a6967f_0c98d57376be4290aba002d8ba028a92~mv2.webp" 
                     alt="MULTI WASHER" 
                     class="mx-auto h-16 md:h-20 w-auto mb-3"
                     onerror="this.onerror=null; this.innerHTML='<h1 class=\'text-3xl font-bold text-white\'>MULTI WASHER</h1>'">
                <div class="inline-block p-0.5 rounded-lg mt-1" style="background: linear-gradient(90deg, rgba(81, 184, 234, 1) 0%, rgba(27, 71, 148, 1) 100%);">
                    <div class="px-3 py-1.5 rounded-md bg-black">
                        <p class="text-white font-semibold uppercase text-xs tracking-widest" data-translate="Checklist Instalação">Checklist Instalação</p>
                    </div>
                </div>
            </div>
            
            <!-- Seletor de Idioma -->
            <div class="mb-6 pb-6 border-b border-gray-700">
                <label class="block text-sm font-medium text-gray-300 mb-2" data-translate="Selecione o idioma">Selecione o idioma</label>
                <div class="flex justify-center gap-1.5 md:gap-2">
                    <!-- PT -->
                    <div class="p-0.5 rounded-lg" style="background: linear-gradient(90deg, rgba(81, 184, 234, 1) 0%, rgba(27, 71, 148, 1) 100%);">
                        <button onclick="setLanguage('pt')" 
                            class="language-btn bg-black px-2 md:px-4 py-2 rounded-md font-semibold transition duration-200 flex items-center gap-1.5 md:gap-2 text-sm md:text-base text-white"
                            data-lang="pt">
                            <svg width="20" height="20" viewBox="0 0 24 24" class="md:w-6 md:h-6" style="border-radius: 2px; overflow: hidden;">
                                <rect width="10" height="24" fill="#006600"/>
                                <rect x="10" width="14" height="24" fill="#FF0000"/>
                            </svg>
                            PT
                        </button>
                    </div>
                    <!-- EN -->
                    <div class="p-0.5 rounded-lg" style="background: linear-gradient(90deg, rgba(81, 184, 234, 1) 0%, rgba(27, 71, 148, 1) 100%);">
                        <button onclick="setLanguage('en')" 
                            class="language-btn bg-black px-2 md:px-4 py-2 rounded-md font-semibold transition duration-200 flex items-center gap-1.5 md:gap-2 text-sm md:text-base text-white"
                            data-lang="en">
                            <svg width="20" height="20" viewBox="0 0 24 24" class="md:w-6 md:h-6" style="border-radius: 2px; overflow: hidden;">
                                <rect width="24" height="24" fill="#012169"/>
                                <path d="M0,0 L24,24 M24,0 L0,24" stroke="white" stroke-width="3"/>
                                <path d="M0,0 L24,24 M24,0 L0,24" stroke="#C8102E" stroke-width="2"/>
                                <path d="M12,0 L12,24 M0,12 L24,12" stroke="white" stroke-width="5"/>
                                <path d="M12,0 L12,24 M0,12 L24,12" stroke="#C8102E" stroke-width="3"/>
                            </svg>
                            EN
                        </button>
                    </div>
                    <!-- ES -->
                    <div class="p-0.5 rounded-lg" style="background: linear-gradient(90deg, rgba(81, 184, 234, 1) 0%, rgba(27, 71, 148, 1) 100%);">
                        <button onclick="setLanguage('es')" 
                            class="language-btn bg-black px-2 md:px-4 py-2 rounded-md font-semibold transition duration-200 flex items-center gap-1.5 md:gap-2 text-sm md:text-base text-white"
                            data-lang="es">
                            <svg width="20" height="20" viewBox="0 0 24 24" class="md:w-6 md:h-6" style="border-radius: 2px; overflow: hidden;">
                                <rect width="24" height="6" fill="#AA151B"/>
                                <rect y="6" width="24" height="12" fill="#F1BF00"/>
                                <rect y="18" width="24" height="6" fill="#AA151B"/>
                            </svg>
                            ES
                        </button>
                    </div>
                    <!-- FR -->
                    <div class="p-0.5 rounded-lg" style="background: linear-gradient(90deg, rgba(81, 184, 234, 1) 0%, rgba(27, 71, 148, 1) 100%);">
                        <button onclick="setLanguage('fr')" 
                            class="language-btn bg-black px-2 md:px-4 py-2 rounded-md font-semibold transition duration-200 flex items-center gap-1.5 md:gap-2 text-sm md:text-base text-white"
                            data-lang="fr">
                            <svg width="20" height="20" viewBox="0 0 24 24" class="md:w-6 md:h-6" style="border-radius: 2px; overflow: hidden;">
                                <rect width="8" height="24" fill="#002395"/>
                                <rect x="8" width="8" height="24" fill="#FFFFFF"/>
                                <rect x="16" width="8" height="24" fill="#ED2939"/>
                            </svg>
                            FR
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 1. ACESSO EXISTENTE -->
            <div class="p-6 border border-gray-700 rounded-xl mb-6 bg-gray-900">
                 <h2 class="text-xl font-semibold text-white mb-4" data-translate="Aceder Equipamento Existente">1. Aceder Equipamento Existente</h2>
                 <p class="text-gray-400 mb-4 text-sm" data-translate="Insira o número de série para continuar a editar uma checklist.">Insira o número de série para continuar a editar uma checklist.</p>
                <form onsubmit="accessExistingEquipment(event)" class="space-y-4">
                    <div>
                        <input type="text" id="accessSerialInput" data-translate-placeholder="Número de Série Ex:" placeholder="Número de Série Ex: 123" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-somengil-blue focus:border-somengil-blue outline-none transition text-center text-lg font-mono placeholder-slate-400">
                        <div id="access-error-message" class="hidden mt-2 text-red-600 text-sm font-medium text-center"></div>
                    </div>
                    <button type="submit" id="access-btn"
                        class="w-full bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg shadow-somengil-blue/30 flex items-center justify-center gap-2 min-h-[48px]">
                        <svg id="access-loading-spinner" class="hidden animate-spin h-5 w-5 text-white flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="access-btn-text" data-translate="Aceder e Editar">Aceder e Editar</span>
                    </button>
                </form>
            </div>

            <!-- 2. CRIAR NOVO -->
            <div class="p-6 border border-gray-700 rounded-xl bg-gray-900">
                 <h2 class="text-xl font-semibold text-white mb-4" data-translate="Adicionar nova instalação">2. Adicionar nova instalação</h2>
                <button onclick="showCreationView()"
                    class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-emerald-600/30"
                    data-translate="Iniciar Nova Checklist">
                    Iniciar Nova Checklist
                </button>
            </div>
            
            <!-- Botão de Logout -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <button onclick="logout()"
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-red-600/30"
                    data-translate="Sair">
                    Sair
                </button>
            </div>
            
            <div class="mt-8 pt-6 border-t border-gray-700 text-xs text-gray-500">
                &copy; Somengil 2025.
            </div>
            </div>
        </div>
    </div>


    <!-- Creation Form View (Formulário Mínimo de Criação) -->
    <div id="creation-form-view" class="hidden fixed inset-0 overflow-y-scroll bg-somengil-light">
        <div class="min-h-screen flex items-center justify-center p-4 md:p-8">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-4xl my-8">
            
            <!-- TABS -->
            <div class="flex gap-4 mb-6 border-b border-gray-200">
                <button onclick="showCreationTab('new-equipment')" id="tab-new-equipment" class="py-2 px-4 font-semibold text-somengil-blue border-b-2 border-somengil-blue" data-translate="Criar Novo">Criar Novo Equipamento</button>
                <button onclick="showCreationTab('all-equipment')" id="tab-all-equipment" class="py-2 px-4 font-semibold text-gray-600 border-b-2 border-transparent hover:text-somengil-blue" data-translate="Ver Todos">Ver Todos os Equipamentos</button>
            </div>
            
            <!-- TAB: CRIAR NOVO EQUIPAMENTO -->
            <div id="tab-content-new-equipment" class="block">
                <h2 class="text-2xl font-bold text-somengil-blue mb-2" data-translate="Novo Equipamento - Dados Iniciais">Novo Equipamento - Dados Iniciais</h2>
                <p class="text-slate-500 mb-6" data-translate="Estes dados serão usados para criar o novo separador da checklist.">Estes dados serão usados para criar o novo separador da checklist.</p>
                
                <form onsubmit="window.createNewEquipment(event)" class="space-y-6 max-w-2xl">
                    
                    <!-- Serial Number -->
                    <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                        <label class="block text-sm font-bold text-somengil-blue mb-3" data-translate="Número de Série (Nome do Separador na Sheet)">Número de Série (Nome do Separador na Sheet)</label>
                        
                        <div class="mb-4">
                            <label class="block text-xs text-gray-600 mb-2" data-translate="Introduza o novo Número de Série">Introduza o novo Número de Série</label>
                            <input type="text" id="creationSerialInput" placeholder="Ex: 001, 999, ABC-123, etc" required
                                class="w-full px-4 py-3 border-2 border-blue-400 rounded-lg focus:ring-2 focus:ring-somengil-blue focus:border-somengil-blue outline-none transition text-lg font-mono placeholder-slate-400">
                        </div>

                        <div class="hidden">
                            <label class="block text-xs text-gray-600 mb-2">Sugestão:</label>
                            <div id="serialSuggestion" class="bg-white border-2 border-blue-300 rounded-lg px-4 py-3 font-mono text-base font-bold text-somengil-blue cursor-pointer hover:bg-blue-50 transition" onclick="applySuggestion()">
                                ---
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between pt-4">
                        <button type="button" onclick="showActionView()"
                            class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition font-medium"
                            data-translate="Voltar">
                            Cancelar
                        </button>
                        <button type="submit" id="create-checklist-btn"
                            class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-3 px-8 rounded-lg shadow-lg shadow-somengil-blue/30 transition-all"
                            data-translate="Criar Checklist">
                            Criar Checklist
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- TAB: VER TODOS OS EQUIPAMENTOS -->
            <div id="tab-content-all-equipment" class="hidden">
                <h2 class="text-2xl font-bold text-somengil-blue mb-2" data-translate="Ver Todos os Equipamentos">Ver Todos os Equipamentos</h2>
                <p class="text-slate-500 mb-6">Listagem de todos os equipamentos no Compliance Sheet</p>
                
                <div id="equipment-loading" class="text-center py-8">
                    <div class="inline-block animate-spin h-8 w-8 text-somengil-blue">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <p class="mt-2 text-gray-600">A carregar equipamentos...</p>
                </div>
                
                <div id="equipment-list-container" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-somengil-blue text-white">
                                    <th class="border border-gray-300 p-2 text-left">ID/Serial</th>
                                    <th class="border border-gray-300 p-2 text-left">Timestamp</th>
                                    <th class="border border-gray-300 p-2 text-left">Técnico</th>
                                    <th class="border border-gray-300 p-2 text-left">Cliente</th>
                                    <th class="border border-gray-300 p-2 text-left">Modelo</th>
                                    <th class="border border-gray-300 p-2 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="equipment-table-body">
                                <!-- Preenchido por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="equipment-empty" class="hidden text-center py-8">
                    <p class="text-gray-600 text-lg">Nenhum equipamento encontrado</p>
                </div>
                
                <div class="flex justify-between mt-8">
                     <button type="button" onclick="logout()"
                        class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition"
                        data-translate="Voltar">
                        Voltar
                    </button>
                </div>
            </div>
            </div>
        </div>
    </div>    <!-- App View (Checklist Principal) -->
    <div id="app-view" class="hidden flex h-screen">
        
        <!-- Mobile Sidebar Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="closeMobileSidebar()"></div>
        
        <!-- Sidebar -->
        <!-- Fundo PRETO, texto branco. Reordenado: Navegação > Progresso > Imagem > Sair. -->
        <aside class="sidebar w-[278px] bg-somengil-dark border-r border-gray-900 flex flex-col z-10 shadow-xl relative overflow-hidden rounded-tr-3xl rounded-br-3xl md:rounded-tr-3xl md:rounded-br-3xl rounded-none">
            
            <!-- Conteúdo da Sidebar -->
            <div class="relative z-10 flex flex-col h-full overflow-y-auto">

                <div class="flex-shrink-0 px-4 md:px-6 py-3 md:py-4 border-b border-gray-800 flex items-center justify-between">
                    <div class="flex-1">
                        <h2 class="font-bold text-xl text-white">Checklist</h2>
                        <div class="flex items-center mt-2 text-sm text-blue-300 font-mono bg-gray-900/50 px-2 py-1 rounded w-fit">
                            <span id="display-serial">S/N: ...</span>
                        </div>
                    </div>
                    
                    <!-- Progress Chart - Mobile Only (no topo) -->
                    <div class="md:hidden flex items-center mr-3">
                        <div class="chart-container" style="max-width: 50px; height: 50px;">
                            <canvas id="progressChartMobile"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white pointer-events-none" id="progress-text-mobile">0%</div>
                        </div>
                    </div>
                    
                    <!-- Mobile Close Button -->
                    <button onclick="closeMobileSidebar()" class="mobile-close-btn text-white hover:text-gray-300 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Navigation - Compliance Sections -->
                <nav id="nav-compliance-sections" class="flex-shrink-0 py-1 md:py-2 space-y-0 overflow-y-auto max-h-96">
                    <!-- Separadores gerados dinamicamente pela função renderNavigation() -->
                </nav>
                
                <!-- Progress Widget - Desktop Only (na posição original) -->
                <div class="flex-shrink-0 hidden md:block px-4 py-3 bg-gradient-to-b from-black to-transparent border-t border-gray-800">
                    <div class="flex items-center gap-4">
                        <div class="flex flex-col justify-center">
                            <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider leading-tight">OVERALL</div>
                            <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider leading-tight">PROGRESS</div>
                        </div>
                        <div class="chart-container relative" style="width: 60px; height: 60px;">
                            <canvas id="progressChart"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white pointer-events-none" id="progress-text">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Imagem (Movida abaixo do Progress Widget) -->
                <div class="flex-1 md:flex-1 pl-0 pr-0 pt-2 md:pt-3 pb-0 z-0 pointer-events-none min-h-[80px]">
                    <!--  -->
                    <img src="https://static.wixstatic.com/media/a6967f_2b78d1e889464ca6858ed9102df64d18~mv2.png" 
                         onerror="this.onerror=null; this.src='https://placehold.co/200x50/000000/ffffff?text=SOMENGIL+LOGO'"
                         alt="Logótipo Somengil" class="w-full h-full opacity-80 object-contain object-right-bottom">
                </div>

                <!-- Logout -->
                <button onclick="logout()" class="flex-shrink-0 px-4 py-1.5 md:py-2 text-center text-xs md:text-sm text-red-400 hover:text-red-300 hover:bg-gray-900 transition border-t border-somengil-dark" data-translate="Terminar Sessão">
                    Sair
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main style="background-color: #f7f7f7;" class="flex-1 flex flex-col h-screen overflow-hidden relative rounded-tl-3xl rounded-bl-3xl md:rounded-tl-3xl md:rounded-bl-3xl rounded-none">
            
            <!-- Mobile Menu Button -->
            <button id="mobile-menu-btn" onclick="toggleMobileSidebar()" 
                class="hidden fixed top-4 right-4 z-30 bg-somengil-blue text-white p-3 rounded-lg shadow-lg hover:bg-somengil-accent transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            
            <!-- Content Scroll Area -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8 pb-32 md:pb-32">
                
                <div class="max-w-4xl mx-auto w-full">
                    
                    <!-- Loader -->
                    <div id="loader" class="hidden absolute inset-0 bg-white/80 z-50 flex items-center justify-center backdrop-blur-sm">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-somengil-blue"></div>
                    </div>

                    <!-- Banner Inicial - Foto do Técnico (aparece apenas uma vez) -->
                    <div id="technician-photo-banner" style="background-color: #dfe4e4;" class="rounded-xl shadow-sm border border-gray-200 p-4 md:p-6 mb-4 md:mb-6">
                        <h3 class="text-base md:text-lg font-semibold text-somengil-blue mb-4 text-center">I. Client's Logo</h3>
                        <div class="flex flex-col items-center gap-4">
                            <div id="field-technician_photo-preview" class="w-24 h-24 md:w-32 md:h-32 rounded-full border-4 border-somengil-blue bg-gray-100 flex items-center justify-center overflow-hidden">
                                <span class="text-gray-400 text-sm text-center p-2">Clique para adicionar logo</span>
                            </div>
                            <input type="file" id="field-technician_photo" accept="image/*" class="hidden" onchange="handleTechnicianPhoto(this)">
                            <label for="field-technician_photo" class="inline-block bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-2 px-4 rounded-lg cursor-pointer">
                                Selecionar Logo
                            </label>
                        </div>
                    </div>

                    <!-- Contentor para seções Compliance geradas dinamicamente -->
                    <div id="sections-container">
                        <!-- Seções será renderizadas aqui pela função renderAllSections() -->
                    </div>

                </div>
                
                <!-- Footer Action Bar -->
            </div>
        </main>
    </div>
</body>
</html>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nº Contribuinte</label>
                                    <input type="text" id="field-clienteNIF" class="w-full p-2 border border-gray-300 rounded focus:border-somengil-blue focus:ring-1 focus:ring-somengil-blue outline-none" oninput="saveData()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="field-clienteEmail" class="w-full p-2 border border-gray-300 rounded focus:border-somengil-blue focus:ring-1 focus:ring-somengil-blue outline-none" oninput="saveData()">
                                </div>
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Morada</label>
                                    <input type="text" id="field-clienteMorada" class="w-full p-2 border border-gray-300 rounded focus:border-somengil-blue focus:ring-1 focus:ring-somengil-blue outline-none" oninput="saveData()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Código Postal</label>
                                    <input type="text" id="field-clienteCodigoPostal" class="w-full p-2 border border-gray-300 rounded focus:border-somengil-blue focus:ring-1 focus:ring-somengil-blue outline-none" oninput="saveData()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
                                    <input type="text" id="field-clienteCidade" class="w-full p-2 border border-gray-300 rounded focus:border-somengil-blue focus:ring-1 focus:ring-somengil-blue outline-none" oninput="saveData()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">País</label>
                                    <input type="text" id="field-clientePais" class="w-full p-2 border border-gray-300 rounded focus:border-somengil-blue focus:ring-1 focus:ring-somengil-blue outline-none" oninput="saveData()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Representante</label>
                                    <input type="text" id="field-clienteRepresentante" class="w-full p-2 border border-gray-300 rounded focus:border-somengil-blue focus:ring-1 focus:ring-somengil-blue outline-none" oninput="saveData()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                    <input type="text" id="field-clienteTelefone" class="w-full p-2 border border-gray-300 rounded focus:border-somengil-blue focus:ring-1 focus:ring-somengil-blue outline-none" oninput="saveData()">
                                </div>
                            </div>
                            <!-- Botões de navegação e guardar -->
                            <div class="mt-6 flex justify-between items-center">
                                <div class="flex gap-2">
                                    <button onclick="goToPreviousSection()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg">
                                        «
                                    </button>
                                    <button onclick="goToNextSection()" class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg">
                                        »
                                    </button>
                                </div>
                                <button onclick="saveDataWithFeedback(this)" class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center gap-2 text-sm">
                                    <span class="text-lg">💾</span>
                                    <span data-translate="Guardar Progresso">Guardar Alterações</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 3: EQUIPAMENTO -->
                    <div id="section-3" class="content-section hidden">
                        <div style="background-color: #dfe4e4;" class="rounded-xl shadow-sm border border-gray-200 p-4 md:p-6 mb-4 md:mb-6">
                            <h3 class="text-base md:text-lg font-semibold text-somengil-blue mb-3 md:mb-4 pb-2 border-b border-gray-100">III. Equipamento</h3>
                            
                            <!-- Modelo -->
                            <div class="mb-6">
                                <label class="block text-sm font-bold text-gray-700 mb-3">Modelo</label>
                                <input type="hidden" name="equipamentoModelo" value="">
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoModelo', 'MWS 200')" class="btn-equipamento px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoModelo" data-value="MWS 200">MWS 200</button>
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoModelo', 'MWS 300')" class="btn-equipamento px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoModelo" data-value="MWS 300">MWS 300</button>
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoModelo', 'MWS 500')" class="btn-equipamento px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoModelo" data-value="MWS 500">MWS 500</button>
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoModelo', 'MWS 700')" class="btn-equipamento px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoModelo" data-value="MWS 700">MWS 700</button>
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoModelo', 'MWS 715')" class="btn-equipamento px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoModelo" data-value="MWS 715">MWS 715</button>
                                </div>
                            </div>

                            <!-- Voltagem -->
                            <div class="mb-6">
                                <label class="block text-sm font-bold text-gray-700 mb-3">Voltagem</label>
                                <input type="hidden" name="equipamentoVoltagem" value="">
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoVoltagem', '208V')" class="btn-equipamento px-3 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoVoltagem" data-value="208V">208V</button>
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoVoltagem', '220V')" class="btn-equipamento px-3 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoVoltagem" data-value="220V">220V</button>
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoVoltagem', '230V')" class="btn-equipamento px-3 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoVoltagem" data-value="230V">230V</button>
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoVoltagem', '380V')" class="btn-equipamento px-3 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoVoltagem" data-value="380V">380V</button>
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoVoltagem', '400V')" class="btn-equipamento px-3 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoVoltagem" data-value="400V">400V</button>
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoVoltagem', '440V')" class="btn-equipamento px-3 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoVoltagem" data-value="440V">440V</button>
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoVoltagem', '480V')" class="btn-equipamento px-3 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoVoltagem" data-value="480V">480V</button>
                                    <button type="button" onclick="selectEquipamento(this, 'equipamentoVoltagem', '575V')" class="btn-equipamento px-3 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoVoltagem" data-value="575V">575V</button>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Frequencia -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-3">Frequência</label>
                                    <input type="hidden" name="equipamentoFrequencia" value="">
                                    <div class="flex gap-2">
                                        <button type="button" onclick="selectEquipamento(this, 'equipamentoFrequencia', '50Hz')" class="btn-equipamento px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoFrequencia" data-value="50Hz">50Hz</button>
                                        <button type="button" onclick="selectEquipamento(this, 'equipamentoFrequencia', '60Hz')" class="btn-equipamento px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoFrequencia" data-value="60Hz">60Hz</button>
                                    </div>
                                </div>
                                <!-- Aquecimento -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-3">Aquecimento</label>
                                    <input type="hidden" name="equipamentoAquecimento" value="">
                                    <div class="flex gap-2">
                                        <button type="button" onclick="selectEquipamento(this, 'equipamentoAquecimento', 'Electrico')" class="btn-equipamento px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoAquecimento" data-value="Electrico">Elétrico</button>
                                        <button type="button" onclick="selectEquipamento(this, 'equipamentoAquecimento', 'Vapor')" class="btn-equipamento px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="equipamentoAquecimento" data-value="Vapor">Vapor</button>
                                    </div>
                                </div>
                            </div>

                            <script>
                                function selectEquipamento(btn, fieldName, value) {
                                    // Find the hidden input for this field
                                    const hiddenInput = btn.parentElement.parentElement.querySelector(`input[name="${fieldName}"]`) || 
                                                      btn.parentElement.querySelector(`input[name="${fieldName}"]`);
                                    
                                    // Remove active class from all buttons in this group
                                    const allBtns = btn.parentElement.querySelectorAll('.btn-equipamento');
                                    allBtns.forEach(b => {
                                        b.classList.remove('btn-active-yes', 'btn-active-no');
                                        b.classList.add('btn-inactive');
                                    });
                                    
                                    // Add active class to clicked button
                                    btn.classList.remove('btn-inactive');
                                    btn.classList.add('btn-active-yes');
                                    
                                    // Update hidden input
                                    if (hiddenInput) {
                                        hiddenInput.value = value;
                                    }
                                    
                                    // Save data
                                    saveData();
                                }

                                // CSS for equipamento buttons
                                const styleEquip = document.createElement('style');
                                styleEquip.textContent = `
                                    .btn-equipamento {
                                        min-width: 80px;
                                    }
                                    .btn-equipamento.btn-inactive {
                                        background-color: #f3f4f6;
                                        border-color: #d1d5db;
                                        color: #6b7280;
                                    }
                                    .btn-equipamento.btn-inactive:hover {
                                        background-color: #e5e7eb;
                                        border-color: #9ca3af;
                                    }
                                    .btn-equipamento.btn-active-yes {
                                        background-color: #10b981;
                                        border-color: #059669;
                                        color: white;
                                        font-weight: 600;
                                    }
                                `;
                                document.head.appendChild(styleEquip);
                            </script>
                            <!-- Botões de navegação e guardar -->
                            <div class="mt-6 flex justify-between items-center">
                                <div class="flex gap-2">
                                    <button onclick="goToPreviousSection()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg">
                                        «
                                    </button>
                                    <button onclick="goToNextSection()" class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg">
                                        »
                                    </button>
                                </div>
                                <button onclick="saveDataWithFeedback(this)" class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center gap-2 text-sm">
                                    <span class="text-lg">💾</span>
                                    <span data-translate="Guardar Progresso">Guardar Alterações</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 4: MONTAGEM -->
                    <div id="section-4" class="content-section hidden">
                        <div style="background-color: #dfe4e4;" class="rounded-xl shadow-sm border border-gray-200 p-4 md:p-6 mb-4 md:mb-6">
                            <h3 class="text-base md:text-lg font-semibold text-somengil-blue mb-3 md:mb-4 pb-2 border-b border-gray-100">IV. Equipamento</h3>
                            
                            <div class="space-y-4">
                                <!-- Estado de Entrega -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <label class="block text-sm font-bold text-gray-700 mb-3" data-translate="Estado de Entrega">Estado de entrega</label>
                                    <input type="hidden" name="condicaoMontagem" value="">
                                    <div class="flex flex-wrap gap-2">
                                        <button type="button" onclick="selectMontagem(this, 'condicaoMontagem', 'Assemblada')" class="btn-montagem px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="condicaoMontagem" data-value="Assemblada">
                                            <span data-translate="Assemblada">Assemblada</span>
                                        </button>
                                        <button type="button" onclick="selectMontagem(this, 'condicaoMontagem', 'Parcialmente desmontada')" class="btn-montagem px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="condicaoMontagem" data-value="Parcialmente desmontada">
                                            <span data-translate="Parcialmente desmontada">Parcialmente desmontada</span>
                                        </button>
                                        <button type="button" onclick="selectMontagem(this, 'condicaoMontagem', 'Desmontada')" class="btn-montagem px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="condicaoMontagem" data-value="Desmontada">
                                            <span data-translate="Desmontada">Desmontada</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Tipo de Instalação -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <label class="block text-sm font-bold text-gray-700 mb-3" data-translate="Tipo de Instalação">Tipo de Instalação</label>
                                    <input type="hidden" name="instalacaoTipo" value="">
                                    <div class="flex gap-2">
                                        <button type="button" onclick="selectMontagem(this, 'instalacaoTipo', 'Enterrada')" class="btn-montagem px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="instalacaoTipo" data-value="Enterrada">
                                            <span data-translate="Enterrada">Enterrada</span>
                                        </button>
                                        <button type="button" onclick="selectMontagem(this, 'instalacaoTipo', 'Solo')" class="btn-montagem px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="instalacaoTipo" data-value="Solo">
                                            <span data-translate="Solo">Solo</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Responsabilidade Gradil -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <label class="block text-sm font-bold text-gray-700 mb-3" data-translate="Responsabilidade Gradil">Responsabilidade Gradil</label>
                                    <input type="hidden" name="responsabilidadeGradil" value="">
                                    <div class="flex gap-2">
                                        <button type="button" onclick="selectMontagem(this, 'responsabilidadeGradil', 'Cliente')" class="btn-montagem px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="responsabilidadeGradil" data-value="Cliente">
                                            <span data-translate="Cliente">Cliente</span>
                                        </button>
                                        <button type="button" onclick="selectMontagem(this, 'responsabilidadeGradil', 'SOMENGIL')" class="btn-montagem px-4 py-2 rounded-lg font-medium text-sm transition-all border-2" data-field="responsabilidadeGradil" data-value="SOMENGIL">
                                            <span data-translate="SOMENGIL">SOMENGIL</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <script>
                                function selectMontagem(btn, fieldName, value) {
                                    // Find the hidden input for this field
                                    const hiddenInput = btn.parentElement.parentElement.querySelector(`input[name="${fieldName}"]`);
                                    
                                    // Remove active class from all buttons in this group
                                    const allBtns = btn.parentElement.querySelectorAll('.btn-montagem');
                                    allBtns.forEach(b => {
                                        b.classList.remove('btn-active-yes', 'btn-active-no');
                                        b.classList.add('btn-inactive');
                                    });
                                    
                                    // Add active class to clicked button
                                    btn.classList.remove('btn-inactive');
                                    btn.classList.add('btn-active-yes');
                                    
                                    // Update hidden input
                                    if (hiddenInput) {
                                        hiddenInput.value = value;
                                    }
                                    
                                    // Save data
                                    saveData();
                                }

                                // CSS for montagem buttons
                                const style = document.createElement('style');
                                style.textContent = `
                                    .btn-montagem {
                                        min-width: 120px;
                                    }
                                    .btn-inactive {
                                        background-color: #f3f4f6;
                                        border-color: #d1d5db;
                                        color: #6b7280;
                                    }
                                    .btn-inactive:hover {
                                        background-color: #e5e7eb;
                                        border-color: #9ca3af;
                                    }
                                    .btn-active-yes {
                                        background-color: #10b981;
                                        border-color: #059669;
                                        color: white;
                                        font-weight: 600;
                                    }
                                `;
                                document.head.appendChild(style);
                            </script>
                            <!-- Botões de navegação e guardar -->
                            <div class="mt-6 flex justify-between items-center">
                                <div class="flex gap-2">
                                    <button onclick="goToPreviousSection()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg">
                                        «
                                    </button>
                                    <button onclick="goToNextSection()" class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg">
                                        »
                                    </button>
                                </div>
                                <button onclick="saveDataWithFeedback(this)" class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center gap-2 text-sm">
                                    <span class="text-lg">💾</span>
                                    <span data-translate="Guardar Progresso">Guardar Alterações</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 5: LOGÍSTICA (Checklist style) -->
                    <div id="section-5" class="content-section hidden">
                        <div style="background-color: #dfe4e4;" class="rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-4 md:mb-6">
                            <h3 class="text-base md:text-lg font-semibold text-somengil-blue p-4 md:p-6 pb-3 md:pb-4 border-b border-gray-100" data-translate="V. Logística & Local">V. Logística e Local</h3>
                            
                            <!-- Helper for Toggle Button Row -->
                            <script>
                                function renderToggleRow(label, name, translateKey) {
                                    const yesText = '<span data-translate="Sim">Sim</span>';
                                    const noText = '<span data-translate="Não">Não</span>';
                                    const labelHtml = translateKey ? `<span data-translate="${translateKey}">${label}</span>` : label;
                                    
                                    document.write(`
                                    <div class="flex items-center justify-between p-4 border-b border-gray-50 hover:bg-gray-50 transition">
                                        <span class="text-sm text-gray-700 pr-4">${labelHtml}</span>
                                        <input type="hidden" name="${name}" value="">
                                        <div class="flex items-center gap-2">
                                            <button type="button" 
                                                    onclick="toggleLogistica(this, '${name}', 'Sim')" 
                                                    class="toggle-btn px-6 py-2 rounded-lg font-medium text-sm transition-all border-2"
                                                    data-name="${name}" 
                                                    data-value="Sim">
                                                ${yesText}
                                            </button>
                                            <button type="button" 
                                                    onclick="toggleLogistica(this, '${name}', 'Não')" 
                                                    class="toggle-btn px-6 py-2 rounded-lg font-medium text-sm transition-all border-2"
                                                    data-name="${name}" 
                                                    data-value="Não">
                                                ${noText}
                                            </button>
                                        </div>
                                    </div>
                                    `);
                                }
                                
                                function toggleLogistica(btn, fieldName, value) {
                                    // Remove active class from all buttons in this group
                                    const container = btn.parentElement;
                                    const allBtns = container.querySelectorAll('.toggle-btn');
                                    allBtns.forEach(b => {
                                        b.classList.remove('btn-active-yes', 'btn-active-no');
                                        b.classList.add('btn-inactive');
                                    });
                                    
                                    // Add active class to clicked button
                                    btn.classList.remove('btn-inactive');
                                    if (value === 'Sim') {
                                        btn.classList.add('btn-active-yes');
                                    } else if (value === 'Não') {
                                        btn.classList.add('btn-active-no');
                                    } else {
                                        // Para outros valores (como tamanhos de adaptador), usa verde
                                        btn.classList.add('btn-active-yes');
                                    }
                                    
                                    // Update hidden input
                                    const hiddenInput = container.parentElement.querySelector(`input[name="${fieldName}"]`);
                                    if (hiddenInput) {
                                        hiddenInput.value = value;
                                    }
                                    
                                    // Save data
                                    saveData();
                                }
                            </script>
                            
                            <style>
                                .toggle-btn {
                                    min-width: 80px;
                                }
                                .btn-inactive {
                                    background-color: #f3f4f6;
                                    border-color: #d1d5db;
                                    color: #6b7280;
                                }
                                .btn-inactive:hover {
                                    background-color: #e5e7eb;
                                    border-color: #9ca3af;
                                }
                                .btn-active-yes {
                                    background-color: #10b981;
                                    border-color: #059669;
                                    color: white;
                                    font-weight: 600;
                                }
                                .btn-active-no {
                                    background-color: #ef4444;
                                    border-color: #dc2626;
                                    color: white;
                                    font-weight: 600;
                                }
                            </style>

                            <div class="divide-y divide-gray-100">
                                <!-- Logística -->
                                <div class="bg-gray-50 p-2 px-4 text-xs font-bold text-gray-500 uppercase"><span data-translate="Acesso e Descarga">Acesso e Descarga</span></div>
                                <script>
                                    renderToggleRow("Pode receber um camião TIR?", "podeReceberTIR", "Pode receber TIR?");
                                    renderToggleRow("Tem empilhador (2.5Ton)?", "temEmpilhador", "Tem empilhador?");
                                    renderToggleRow("Tem capacidade descarregar o equipamento sem a presença de Técnico Somengil?", "podeDescarregarSemTecnico", "Descarga s/ Técnico");
                                    renderToggleRow("Tem técnico para auxiliar na instalação do equipamento?", "temTecnicoAuxiliar", "Técnico auxiliar?");
                                    renderToggleRow("Pode armazenar equipamento?", "podeArmazenar", "Armazenar equip.?");
                                    renderToggleRow("É necessário cintas?", "necessarioCintas", "Necessário cintas?");
                                </script>

                                <!-- Instalações -->
                                <div class="bg-gray-50 p-2 px-4 text-xs font-bold text-gray-500 uppercase"><span data-translate="Infraestruturas">Infraestruturas</span></div>
                                <script>
                                    renderToggleRow("Tem água na sala?", "temAguaSala", "Tem água na sala?");
                                </script>
                                <div class="p-4 border-b border-gray-50">
                                    <div class="flex flex-col gap-3">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-700" data-translate="Tam. adaptador água">Tamanho adaptador água</span>
                                            <input type="hidden" name="adaptadorAguaTamanho" value="">
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <button type="button" 
                                                        onclick="selectAdaptador(this, '3/8&quot;')" 
                                                        class="toggle-btn px-4 py-2 rounded-lg font-medium text-sm transition-all border-2"
                                                        data-name="adaptadorAguaTamanho" 
                                                        data-value="3/8&quot;">
                                                    3/8"
                                                </button>
                                                <button type="button" 
                                                        onclick="selectAdaptador(this, '1/2&quot;')" 
                                                        class="toggle-btn px-4 py-2 rounded-lg font-medium text-sm transition-all border-2"
                                                        data-name="adaptadorAguaTamanho" 
                                                        data-value="1/2&quot;">
                                                    1/2"
                                                </button>
                                                <button type="button" 
                                                        onclick="selectAdaptador(this, '3/4&quot;')" 
                                                        class="toggle-btn px-4 py-2 rounded-lg font-medium text-sm transition-all border-2"
                                                        data-name="adaptadorAguaTamanho" 
                                                        data-value="3/4&quot;">
                                                    3/4"
                                                </button>
                                                <button type="button" 
                                                        onclick="selectAdaptador(this, 'Outra')" 
                                                        class="toggle-btn px-4 py-2 rounded-lg font-medium text-sm transition-all border-2"
                                                        data-name="adaptadorAguaTamanho" 
                                                        data-value="Outra"
                                                        id="btn-adaptador-outra">
                                                    <span data-translate="Outra">Outra</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="adaptador-outro-container" class="hidden items-center gap-2">
                                            <label class="text-sm text-gray-600" data-translate="Especifique">Especifique:</label>
                                            <input type="text" 
                                                   id="adaptadorAguaTamanhoOutro" 
                                                   class="flex-1 px-3 py-2 bg-gray-50 border-2 border-gray-300 rounded-lg text-sm outline-none focus:border-somengil-blue focus:ring-2 focus:ring-somengil-blue/20 transition-all" 
                                                   placeholder="Ex: 5/8"
                                                   oninput="handleAdaptadorOutro(this)">
                                        </div>
                                    </div>
                                </div>
                                <script>
                                    function selectAdaptador(btn, value) {
                                        // Remove active class from all buttons
                                        const container = btn.parentElement;
                                        const allBtns = container.querySelectorAll('.toggle-btn');
                                        allBtns.forEach(b => {
                                            b.classList.remove('btn-active-yes', 'btn-active-no');
                                            b.classList.add('btn-inactive');
                                        });
                                        
                                        // Add active class to clicked button
                                        btn.classList.remove('btn-inactive');
                                        
                                        const outroContainer = document.getElementById('adaptador-outro-container');
                                        const outroInput = document.getElementById('adaptadorAguaTamanhoOutro');
                                        
                                        if (value === 'Outra') {
                                            // Botão "Outra" fica vermelho
                                            btn.classList.add('btn-active-no');
                                            // Mostra o campo de texto
                                            outroContainer.classList.remove('hidden');
                                            outroContainer.classList.add('flex');
                                            // Foca no input
                                            setTimeout(() => outroInput.focus(), 100);
                                        } else {
                                            // Outros botões ficam verdes
                                            btn.classList.add('btn-active-yes');
                                            // Esconde o campo de texto
                                            outroContainer.classList.add('hidden');
                                            outroContainer.classList.remove('flex');
                                            // Limpa o campo de texto
                                            outroInput.value = '';
                                            // Update hidden input com o valor do botão
                                            const hiddenInput = document.querySelector('input[name="adaptadorAguaTamanho"]');
                                            if (hiddenInput) {
                                                hiddenInput.value = value;
                                            }
                                            saveData();
                                        }
                                    }
                                    
                                    function handleAdaptadorOutro(input) {
                                        let value = input.value.trim();
                                        if (value && !value.endsWith('"')) {
                                            value = value + '"';
                                        }
                                        const hiddenInput = document.querySelector('input[name="adaptadorAguaTamanho"]');
                                        if (hiddenInput) {
                                            hiddenInput.value = value;
                                        }
                                        saveData();
                                    }
                                </script>
                                </div>
                                <script>
                                    renderToggleRow("Tem energia eléctrica?", "temEnergiaEletrica", "Energia eléctrica?");
                                    renderToggleRow("Tem escadas?", "temEscadas", "Tem escadas?");
                                    renderToggleRow("Tem ficha eléctrica?", "temFichaEletrica", "Tem ficha eléctrica?");
                                </script>
                                <div class="p-4 border-b border-gray-50 flex items-center justify-between bg-blue-50/50" onchange="saveData()">
                                    <span class="text-sm text-gray-700 font-medium" data-translate="Opção dos Amperes">Opção dos Amperes</span>
                                    <div class="flex space-x-3 text-xs">
                                        <label class="inline-flex items-center cursor-pointer"><input type="radio" name="amperesOpcao" value="16A SP" class="form-radio text-somengil-blue focus:ring-somengil-blue"> <span class="ml-1">16A SP</span></label>
                                        <label class="inline-flex items-center cursor-pointer"><input type="radio" name="amperesOpcao" value="32A 5P" class="form-radio text-somengil-blue focus:ring-somengil-blue"> <span class="ml-1">32A 5P</span></label>
                                        <label class="inline-flex items-center cursor-pointer"><input type="radio" name="amperesOpcao" value="63A SP" class="form-radio text-somengil-blue focus:ring-somengil-blue"> <span class="ml-1">63A SP</span></label>
                                    </div>
                                </div>

                                <!-- Preparação -->
                                <div class="bg-gray-50 p-2 px-4 text-xs font-bold text-gray-500 uppercase"><span data-translate="Preparação">Preparação</span></div>
                                <script>
                                    renderToggleRow("Tem detergentes?", "temDetergentes", "Tem detergentes?");
                                    renderToggleRow("Documentação p/ entrar na Fábrica?", "documentacaoFabrica", "Doc. p/ Fábrica?");
                                    renderToggleRow("Equipamento Proteção Obrigatório?", "equipamentoProtecao", "Equip. Proteção?");
                                    renderToggleRow("Chão acabado?", "chaoAcabado", "Chão acabado?");
                                    renderToggleRow("Dreno preparado?", "drenoPreparado", "Dreno preparado?");
                                    renderToggleRow("Ventilação preparada?", "ventilacaoPreparada", "Ventilação prep.?");
                                    renderToggleRow("Utensílios sujos para testes?", "temUtensiliosSujos", "Utensílios p/ teste?");
                                </script>

                                <!-- Pessoal -->
                                <div class="bg-gray-50 p-2 px-4 text-xs font-bold text-gray-500 uppercase"><span data-translate="Pessoal">Pessoal</span></div>
                                <div class="p-4 border-b border-gray-50">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm text-gray-700" data-translate="Operador presente?">Operador presente na formação?</span>
                                        <input type="hidden" name="operadorPresente" value="">
                                        <div class="flex items-center gap-2">
                                            <button type="button" 
                                                    onclick="toggleLogistica(this, 'operadorPresente', 'Sim')" 
                                                    class="toggle-btn px-6 py-2 rounded-lg font-medium text-sm transition-all border-2"
                                                    data-name="operadorPresente" 
                                                    data-value="Sim">
                                                <span data-translate="Sim">Sim</span>
                                            </button>
                                            <button type="button" 
                                                    onclick="toggleLogistica(this, 'operadorPresente', 'Não')" 
                                                    class="toggle-btn px-6 py-2 rounded-lg font-medium text-sm transition-all border-2"
                                                    data-name="operadorPresente" 
                                                    data-value="Não">
                                                <span data-translate="Não">Não</span>
                                            </button>
                                        </div>
                                    </div>
                                    <input type="text" id="field-operadorNome" class="w-full text-sm p-2 bg-gray-50 rounded border border-gray-200" data-translate-placeholder="Nome do Operador" placeholder="Nome do Operador..." oninput="saveData()">
                                </div>
                                <div class="p-4 border-b border-gray-50">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm text-gray-700" data-translate="Resp. Comission.">Responsável Comissionamento presente?</span>
                                        <input type="hidden" name="responsavelComissionamentoPresente" value="">
                                        <div class="flex items-center gap-2">
                                            <button type="button" 
                                                    onclick="toggleLogistica(this, 'responsavelComissionamentoPresente', 'Sim')" 
                                                    class="toggle-btn px-6 py-2 rounded-lg font-medium text-sm transition-all border-2"
                                                    data-name="responsavelComissionamentoPresente" 
                                                    data-value="Sim">
                                                <span data-translate="Sim">Sim</span>
                                            </button>
                                            <button type="button" 
                                                    onclick="toggleLogistica(this, 'responsavelComissionamentoPresente', 'Não')" 
                                                    class="toggle-btn px-6 py-2 rounded-lg font-medium text-sm transition-all border-2"
                                                    data-name="responsavelComissionamentoPresente" 
                                                    data-value="Não">
                                                <span data-translate="Não">Não</span>
                                            </button>
                                        </div>
                                    </div>
                                    <input type="text" id="field-responsavelComissionamentoNome" class="w-full text-sm p-2 bg-gray-50 rounded border border-gray-200" placeholder="Nome do Responsável..." oninput="saveData()">
                                </div>

                            </div>
                            <!-- Botões de navegação e guardar -->
                            <div class="mt-6 flex justify-between items-center pr-4 md:pr-6 pb-4 md:pb-6">
                                <div class="flex gap-2">
                                    <button onclick="goToPreviousSection()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg">
                                        «
                                    </button>
                                    <button onclick="goToNextSection()" class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg">
                                        »
                                    </button>
                                </div>
                                <button onclick="saveDataWithFeedback(this)" class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center gap-2 text-sm">
                                    <span class="text-lg">💾</span>
                                    <span data-translate="Guardar Progresso">Guardar Alterações</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 6: INFO EXTRA -->
                    <div id="section-6" class="content-section hidden">
                        <div style="background-color: #dfe4e4;" class="rounded-xl shadow-sm border border-gray-200 p-4 md:p-6 mb-4 md:mb-6">
                            <h3 class="text-base md:text-lg font-semibold text-somengil-blue mb-3 md:mb-4 pb-2 border-b border-gray-100" data-translate="VI. Info & Medições">VI. Informação Adicional</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="Pressão Água">Ligações Pressão Água (2bar rec.)</label>
                                    <textarea id="field-ligacoesPressaoAgua" rows="2" class="w-full p-2 border border-gray-300 rounded focus:border-somengil-blue focus:ring-1 focus:ring-somengil-blue outline-none" oninput="saveData()"></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="Marca Químicos">Marca Produtos Químicos</label>
                                    <input type="text" id="field-marcaProdutosQuimicos" class="w-full p-2 border border-gray-300 rounded outline-none" oninput="saveData()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="Data Entrega">Data Entrega Prevista</label>
                                    <input type="date" id="field-dataEntregaPrevista" class="w-full p-2 border border-gray-300 rounded outline-none" oninput="saveData()">
                                </div>

                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Medições (cm)</label>
                                    <div class="grid grid-cols-3 gap-4">
                                        <div>
                                            <span class="text-xs text-slate-500" data-translate="Largura Porta (cm)">Porta (Largura - cm)</span>
                                            <input type="number" id="field-medicaoPortaLargura" class="w-full p-2 border border-gray-300 rounded mt-1" oninput="saveData()">
                                        </div>
                                        <div>
                                            <span class="text-xs text-slate-500" data-translate="Altura Porta (cm)">Porta (Altura - cm)</span>
                                            <input type="number" id="field-medicaoPortaAltura" class="w-full p-2 border border-gray-300 rounded mt-1" oninput="saveData()">
                                        </div>
                                        <div>
                                            <span class="text-xs text-slate-500" data-translate="Chão ao Teto (cm)">Chão ao Teto (cm)</span>
                                            <input type="number" id="field-medicaoChaoTecto" class="w-full p-2 border border-gray-300 rounded mt-1" oninput="saveData()">
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="Horário (Início)">Horário Trabalho (Início)</label>
                                    <input type="time" id="field-horarioTrabalhoInicio" class="w-full p-2 border border-gray-300 rounded outline-none" oninput="saveData()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="Horário (Fim)">Horário Trabalho (Fim)</label>
                                    <input type="time" id="field-horarioTrabalhoFim" class="w-full p-2 border border-gray-300 rounded outline-none" oninput="saveData()">
                                </div>

                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="Observações">Observações Gerais</label>
                                    <textarea id="field-observacoes" rows="4" class="w-full p-2 border border-gray-300 rounded focus:border-somengil-blue focus:ring-1 focus:ring-somengil-blue outline-none bg-yellow-50/30" oninput="saveData()"></textarea>
                                </div>
                            </div>
                            <!-- Botões de navegação e guardar -->
                            <div class="mt-6 flex justify-between items-center">
                                <div class="flex gap-2">
                                    <button onclick="goToPreviousSection()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg">
                                        «
                                    </button>
                                    <button onclick="goToNextSection()" class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all text-lg">
                                        »
                                    </button>
                                </div>
                                <button onclick="saveDataWithFeedback(this)" class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center gap-2 text-sm">
                                    <span class="text-lg">💾</span>
                                    <span data-translate="Guardar Progresso">Guardar Alterações</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SECTION 7: FOTOS E FICHEIROS (NOVO) -->
                    <div id="section-7" class="content-section hidden">
                        <div style="background-color: #dfe4e4;" class="rounded-xl shadow-sm border border-gray-200 p-4 md:p-6 mb-4 md:mb-6">
                            <h3 class="text-base md:text-lg font-semibold text-somengil-blue mb-3 md:mb-4 pb-2 border-b border-gray-100" data-translate="VII. Fotos e Ficheiros">VII. Fotos e Ficheiros</h3>
                            <p class="text-slate-500 mb-4 text-sm">Carregue fotos de comprovação da instalação. As imagens serão enviadas automaticamente para <strong>qualidade@somengil.com</strong>.</p>
                            
                            <!-- Hidden field para rastrear se fotos foram enviadas -->
                            <input type="hidden" id="field-fotosEnviadas" name="fotosEnviadas" value="">
                            <input type="hidden" id="field-dataEnvioFotos" name="dataEnvioFotos" value="">
                            
                            <!-- Log de envios (readonly) -->
                            <div id="log-envios-container" class="hidden mb-4 p-4 bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <span class="text-lg mr-2">✅</span>
                                    <h4 class="text-sm font-bold text-emerald-800">Histórico de Envios</h4>
                                </div>
                                <div id="log-envios-content" class="text-xs text-slate-700 space-y-1 font-mono">
                                    <!-- Timestamps serão inseridos aqui -->
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Adicionar Fotos</label>
                                <input type="file" id="field-uploadFotos" accept="image/*" multiple 
                                    class="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-somengil-blue transition cursor-pointer bg-gray-50"
                                    onchange="handleImageUpload(event)">
                                <p class="text-xs text-gray-500 mt-2">
                                    <span class="font-medium">📎 Múltiplos ficheiros suportados</span> • Formatos aceites: JPG, PNG, GIF
                                </p>
                                <div id="files-counter" class="hidden mt-2 px-3 py-1.5 bg-blue-100 text-blue-700 text-sm font-medium rounded inline-block">
                                    <!-- Contador será preenchido dinamicamente -->
                                </div>
                            </div>

                            <div id="image-preview-container" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4 hidden">
                                <!-- Previews das imagens serão adicionadas aqui -->
                            </div>

                            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-3">📧</span>
                                    <div>
                                        <p class="text-sm font-medium text-gray-700">Email de Destino</p>
                                        <p class="text-xs text-gray-500">qualidade@somengil.com</p>
                                    </div>
                                </div>
                                <button id="send-photos-btn" onclick="sendPhotosEmail()" disabled
                                    class="bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-2 px-6 rounded-lg transition-all">
                                    Enviar Fotos
                                </button>
                            </div>

                            <div id="email-status" class="mt-3 text-sm hidden"></div>
                        </div>

                        <script>
                            // Tornar funções acessíveis globalmente
                            window.photoUploadState = {
                                selectedImages: [],
                                GOOGLE_SHEET_API_URL: "https://script.google.com/macros/s/AKfycbwoy-S0Ekip6iIheoRxMxOjCPxQc0mv6R5337o0BWr9Bhns0Z3lXK1MYSCi4SKDPsbf/exec"
                            };

                            window.handleImageUpload = function(event) {
                                const files = Array.from(event.target.files);
                                window.photoUploadState.selectedImages = files;
                                
                                console.log('Ficheiros selecionados:', files.length);
                                
                                const container = document.getElementById('image-preview-container');
                                const sendBtn = document.getElementById('send-photos-btn');
                                const counter = document.getElementById('files-counter');
                                
                                if (files.length > 0) {
                                    container.classList.remove('hidden');
                                    
                                    // Habilitar botão explicitamente
                                    sendBtn.disabled = false;
                                    sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                    console.log('Botão habilitado');
                                    
                                    container.innerHTML = '';
                                    
                                    // Atualizar contador
                                    counter.classList.remove('hidden');
                                    counter.textContent = `✓ ${files.length} ficheiro${files.length > 1 ? 's' : ''} selecionado${files.length > 1 ? 's' : ''}`;
                                    
                                    files.forEach((file, index) => {
                                        const reader = new FileReader();
                                        reader.onload = (e) => {
                                            const preview = document.createElement('div');
                                            preview.className = 'relative group';
                                            preview.innerHTML = `
                                                <img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg border border-gray-200">
                                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition flex items-center justify-center rounded-lg">
                                                    <button onclick="removeImage(${index})" class="opacity-0 group-hover:opacity-100 bg-red-500 text-white px-3 py-1 rounded text-xs">
                                                        Remover
                                                    </button>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1 truncate">${file.name}</p>
                                            `;
                                            container.appendChild(preview);
                                        };
                                        reader.readAsDataURL(file);
                                    });
                                } else {
                                    container.classList.add('hidden');
                                    counter.classList.add('hidden');
                                    sendBtn.disabled = true;
                                }
                            };

                            window.removeImage = function(index) {
                                window.photoUploadState.selectedImages.splice(index, 1);
                                const input = document.getElementById('field-uploadFotos');
                                const dt = new DataTransfer();
                                window.photoUploadState.selectedImages.forEach(file => dt.items.add(file));
                                input.files = dt.files;
                                window.handleImageUpload({ target: input });
                            };

                            window.sendPhotosEmail = async function() {
                                const sendBtn = document.getElementById('send-photos-btn');
                                const statusDiv = document.getElementById('email-status');
                                const selectedImages = window.photoUploadState.selectedImages;
                                
                                if (selectedImages.length === 0) {
                                    statusDiv.className = 'mt-3 text-sm text-red-600';
                                    statusDiv.textContent = 'Nenhuma imagem selecionada.';
                                    statusDiv.classList.remove('hidden');
                                    return;
                                }

                                // Obter serial number do state global
                                const serialNumber = window.appState?.serial || 'UNKNOWN';
                                
                                // Obter modelo do equipamento
                                const modeloEquipamento = window.appState?.data?.equipamentoModelo || 'UNKNOWN';

                                console.log('📧 Iniciando envio de fotos:', {
                                    serial: serialNumber,
                                    modelo: modeloEquipamento,
                                    numFotos: selectedImages.length,
                                    appState: window.appState
                                });

                                sendBtn.disabled = true;
                                sendBtn.textContent = 'Enviando...';
                                statusDiv.className = 'mt-3 text-sm text-blue-600';
                                statusDiv.textContent = 'A enviar fotos por email...';
                                statusDiv.classList.remove('hidden');

                                try {
                                    // Converter imagens para base64
                                    const imageData = await Promise.all(
                                        selectedImages.map(file => {
                                            return new Promise((resolve, reject) => {
                                                const reader = new FileReader();
                                                reader.onload = () => resolve({
                                                    name: file.name,
                                                    data: reader.result.split(',')[1],
                                                    mimeType: file.type
                                                });
                                                reader.onerror = reject;
                                                reader.readAsDataURL(file);
                                            });
                                        })
                                    );

                                    // Enviar para Google Apps Script
                                    const payload = {
                                        action: 'sendEmail',
                                        serial: serialNumber,
                                        modelo: modeloEquipamento,
                                        to: 'qualidade@somengil.com',
                                        subject: `Fotos Instalação - Equipamento ${modeloEquipamento}`,
                                        images: imageData
                                    };

                                    console.log('📤 Payload a enviar:', {
                                        action: payload.action,
                                        serial: payload.serial,
                                        modelo: payload.modelo,
                                        to: payload.to,
                                        numImages: payload.images.length
                                    });

                                    // NOTA: Google Apps Script requer mode: 'no-cors' devido a política CORS
                                    // Não conseguimos ler a resposta, mas podemos verificar se o Sheet foi atualizado depois
                                    await fetch(window.photoUploadState.GOOGLE_SHEET_API_URL, {
                                        method: 'POST',
                                        mode: 'no-cors',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(payload)
                                    });

                                    console.log('✅ Requisição enviada (no-cors mode). Aguardando processamento...');
                                    
                                    statusDiv.className = 'mt-3 text-sm text-emerald-600 font-medium';
                                    statusDiv.textContent = `✓ ${selectedImages.length} foto(s) enviada(s) com sucesso para qualidade@somengil.com!`;
                                    
                                    // Aguardar Apps Script processar (3 segundos para garantir)
                                    await new Promise(resolve => setTimeout(resolve, 3000));
                                    
                                    // Recarregar dados do Sheet para verificar se foi atualizado
                                    if (window.appState && window.appState.serial) {
                                        console.log('🔄 Recarregando dados do Sheet...');
                                        await window.loadSheetData(window.appState.serial);
                                        
                                        // Verificar se as fotos foram marcadas como enviadas
                                        const fotosEnviadas = window.appState.data.fotosEnviadas;
                                        const dataEnvio = window.appState.data.dataEnvioFotos;
                                        
                                        console.log('📊 Estado após reload:', {
                                            fotosEnviadas,
                                            dataEnvio,
                                            temTimestamp: !!dataEnvio
                                        });
                                        
                                        window.calculateAndDisplayProgress(window.appState.data);
                                        window.displayPhotoLog(window.appState.data.dataEnvioFotos);
                                        
                                        // Mostrar aviso se não foi atualizado
                                        if (fotosEnviadas !== 'Sim') {
                                            console.warn('⚠️ AVISO: Campo "Fotos Enviadas" não foi atualizado para "Sim"');
                                            statusDiv.textContent += ' (Verifique o Google Sheets manualmente)';
                                        }
                                    }
                                    
                                    // Limpar seleção
                                    setTimeout(() => {
                                        document.getElementById('field-uploadFotos').value = '';
                                        window.photoUploadState.selectedImages = [];
                                        document.getElementById('image-preview-container').classList.add('hidden');
                                        document.getElementById('files-counter').classList.add('hidden');
                                        sendBtn.disabled = true;
                                        sendBtn.textContent = 'Enviar Fotos';
                                    }, 3000);

                                } catch (error) {
                                    console.error('Erro ao enviar fotos:', error);
                                    statusDiv.className = 'mt-3 text-sm text-red-600';
                                    statusDiv.textContent = '✗ Erro ao enviar fotos. Tente novamente.';
                                    sendBtn.disabled = false;
                                    sendBtn.textContent = 'Enviar Fotos';
                                }
                            };
                        </script>
                        <!-- Botão Guardar no final da secção -->
                        <div class="mt-6 flex justify-end pr-4 md:pr-6 pb-4 md:pb-6">
                            <button onclick="saveDataWithFeedback(this)" class="bg-somengil-blue hover:bg-somengil-accent text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center gap-2 text-sm">
                                <span class="text-lg">💾</span>
                                <span data-translate="Guardar Progresso">Guardar Alterações</span>
                            </button>
                        </div>
                    </div>

                </div>
                
                <!-- Footer Action Bar -->
            </div>
        </main>
    </div>
</body>
</html>
